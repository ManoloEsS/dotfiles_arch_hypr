# Makefile for Simplified Arch Linux Dotfiles Setup
# This Makefile automates dotfile restoration and configuration

# Variables
DOTFILES_DIR := $(HOME)/dotfiles_arch_hypr
NVIM_CONFIG_DIR := ${XDG_CONFIG_HOME:-$(HOME)/.config}/nvim
STOW_DIRS := fontconfig hypr pl10k tmux waybar wezterm wofi zsh

# Phony targets
.PHONY: all check-dotfiles install-packages install-ohmyzsh setup-ohmyzsh-plugins change-shell cleanup-and-stow verify-configs verify-complete-setup clean help

# Default target - simplified dotfile setup
all: check-dotfiles install-packages install-ohmyzsh setup-ohmyzsh-plugins change-shell cleanup-and-stow verify-complete-setup
	@echo "=== Simplified dotfiles setup completed ==="
	@echo "Packages restored from existing lists"
	@echo "Oh My Zsh with plugins configured"
	@echo "Configuration files stowed successfully"

# Check if dotfiles exist locally, skip cloning if they do
check-dotfiles:
	@echo "=== Checking dotfiles directory ==="
	@if [ -d "$(DOTFILES_DIR)" ]; then \
		echo "✅ Dotfiles directory already exists locally"; \
		echo "Skipping clone to preserve existing configurations"; \
	else \
		echo "❌ Dotfiles directory not found at $(DOTFILES_DIR)"; \
		echo "Please ensure dotfiles are available before running this script"; \
		exit 1; \
	fi

# Install packages using the restore script
install-packages:
	@echo "=== Installing packages ==="
	@# Run package restore script (handles yay installation automatically)
	cd $(DOTFILES_DIR)/packages && ./arch_package_backup_and_restore.sh restore || exit 1
	@echo "=== Package installation completed ==="

# Setup Oh My Zsh plugins and themes
setup-ohmyzsh-plugins:
	@echo "=== Setting up Oh My Zsh plugins and themes ==="
	@# Ensure custom directories exist
	mkdir -p "$(HOME)/.oh-my-zsh/custom/plugins" || exit 1
	mkdir -p "$(HOME)/.oh-my-zsh/custom/themes" || exit 1
	@# Install zsh-syntax-highlighting plugin
	@if [ ! -d "$(HOME)/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting" ]; then \
		echo "Installing zsh-syntax-highlighting plugin..."; \
		git clone --depth=1 https://github.com/zsh-users/zsh-syntax-highlighting.git "$(HOME)/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting" || exit 1; \
	fi
	@# Install zsh-autosuggestions plugin
	@if [ ! -d "$(HOME)/.oh-my-zsh/custom/plugins/zsh-autosuggestions" ]; then \
		echo "Installing zsh-autosuggestions plugin..."; \
		git clone --depth=1 https://github.com/zsh-users/zsh-autosuggestions.git "$(HOME)/.oh-my-zsh/custom/plugins/zsh-autosuggestions" || exit 1; \
	fi
	@# Install zsh-completions plugin
	@if [ ! -d "$(HOME)/.oh-my-zsh/custom/plugins/zsh-completions" ]; then \
		echo "Installing zsh-completions plugin..."; \
		git clone --depth=1 https://github.com/zsh-users/zsh-completions.git "$(HOME)/.oh-my-zsh/custom/plugins/zsh-completions" || exit 1; \
	fi
	@# Install fzf-tab plugin
	@if [ ! -d "$(HOME)/.oh-my-zsh/custom/plugins/fzf-tab" ]; then \
		echo "Installing fzf-tab plugin..."; \
		git clone --depth=1 https://github.com/Aloxaf/fzf-tab.git "$(HOME)/.oh-my-zsh/custom/plugins/fzf-tab" || exit 1; \
	fi
	@# Install Powerlevel10k theme
	@if [ ! -d "$(HOME)/.oh-my-zsh/custom/themes/powerlevel10k" ]; then \
		echo "Installing Powerlevel10k theme..."; \
		git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "$(HOME)/.oh-my-zsh/custom/themes/powerlevel10k" || exit 1; \
	fi
	@echo "=== Oh My Zsh plugins and themes setup completed ==="

# Install Oh My Zsh manually (avoid installer config conflicts)
install-ohmyzsh:
	@echo "=== Installing Oh My Zsh manually ==="
	@# Backup existing configs before cleanup
	@if [ -f "$(HOME)/.zshrc" ]; then \
		cp "$(HOME)/.zshrc" "$(HOME)/.zshrc.backup.$(shell date +%Y%m%d_%H%M%S)" && \
		echo "Backed up existing .zshrc"; \
	fi
	@if [ -f "$(HOME)/.bashrc" ]; then \
		cp "$(HOME)/.bashrc" "$(HOME)/.bashrc.backup.$(shell date +%Y%m%d_%H%M%S)" && \
		echo "Backed up existing .bashrc"; \
	fi
	@# Clean and clone Oh My Zsh
	@rm -rf "$(HOME)/.oh-my-zsh" "$(HOME)/.zshrc" 2>/dev/null || true
	git clone --depth=1 https://github.com/ohmyzsh/ohmyzsh.git "$(HOME)/.oh-my-zsh" || exit 1
	@echo "=== Manual Oh My Zsh installation completed ==="

# Change default shell to zsh
change-shell:
	@echo "=== Changing default shell to zsh ==="
	@if command -v zsh >/dev/null 2>&1; then \
		if [ "$$SHELL" != "/usr/bin/zsh" ] && [ "$$SHELL" != "$(which zsh)" ]; then \
			echo "/usr/bin/zsh" | sudo chsh $$USER || exit 1; \
			echo "Default shell changed to zsh"; \
		else \
			echo "Default shell is already zsh"; \
		fi; \
	else \
		echo "ERROR: zsh is not installed"; \
		echo "Installing zsh..."; \
		sudo pacman -S --noconfirm zsh || exit 1; \
		echo "/usr/bin/zsh" | sudo chsh $$USER || exit 1; \
		echo "Default shell changed to zsh"; \
	fi
	@echo "=== Shell change completed ==="

# Combined cleanup and stow with backup protection
cleanup-and-stow:
	@echo "=== Clean configuration setup ==="
	@# Backup critical configs if they exist
	@if [ -f "/etc/X11/xinitrc" ]; then \
		cp "/etc/X11/xinitrc" "/etc/X11/xinitrc.backup.$(shell date +%Y%m%d_%H%M%S)" && \
		echo "Backed up system xinitrc"; \
	fi
	@if [ -f "$(HOME)/.bashrc" ]; then \
		cp "$(HOME)/.bashrc" "$(HOME)/.bashrc.backup.$(shell date +%Y%m%d_%H%M%S)" && \
		echo "Backed up user bashrc"; \
	fi
	@# Remove all target config directories
	@for dir in $(STOW_DIRS); do \
		if [ -d "$(HOME)/.config/$$dir" ]; then \
			echo "Removing .config/$$dir..."; \
			rm -rf "$(HOME)/.config/$$dir"; \
		fi; \
		if [ -d "$(HOME)/.$$dir" ]; then \
			echo "Removing .$$dir..."; \
			rm -rf "$(HOME)/.$$dir"; \
		fi; \
	done
	@# Remove existing Neovim config
	@if [ -d "$(NVIM_CONFIG_DIR)" ]; then \
		rm -rf "$(NVIM_CONFIG_DIR)"; \
	fi
	@# Cleanup broken symlinks
	@find "$(HOME)/.config" -maxdepth 2 -type l -exec test ! -e {} \; -delete 2>/dev/null || true
	@# Stow all configurations
	@echo "Stowing configurations..."
	cd $(DOTFILES_DIR) && \
	for dir in $(STOW_DIRS); do \
		if [ -d "$$dir" ]; then \
			echo "Stowing $$dir..."; \
			stow -d $(DOTFILES_DIR) -t $(HOME) $$dir || exit 1; \
		fi; \
	done
	@echo "=== Cleanup and stowing completed ==="
	@$(MAKE) -f $(firstword $(MAKEFILE_LIST)) verify-configs

# Verify critical configurations
verify-configs:
	@echo "=== Verifying critical configurations ==="
	@# Check shell config
	@if [ ! -f "$(HOME)/.zshrc" ]; then \
		echo "❌ .zshrc not found after stowing"; \
		exit 1; \
	fi
	@# Check .zprofile for TTY autostart
	@if [ ! -f "$(HOME)/.zprofile" ]; then \
		echo "❌ .zprofile not found after stowing"; \
		exit 1; \
	fi
	@# Check Hyprland config
	@if [ ! -f "$(HOME)/.config/hypr/hyprland.conf" ]; then \
		echo "❌ Hyprland config not found after stowing"; \
		exit 1; \
	fi
	@# Check Waybar config (config.jsonc or config)
	@if [ ! -f "$(HOME)/.config/waybar/config.jsonc" ] && [ ! -f "$(HOME)/.config/waybar/config" ]; then \
		echo "❌ Waybar config not found after stowing"; \
		exit 1; \
	fi
	@
	@echo "✅ All critical configurations verified"

# Final setup verification
verify-complete-setup:
	@echo "=== Final setup verification ==="
	@# Verify shell
	@if [ "$(SHELL)" != "$(which zsh)" ]; then \
		echo "⚠️  Warning: Shell not changed to zsh yet"; \
	else \
		echo "✅ Shell properly set to zsh"; \
	fi
	@# Verify key tools
	@for cmd in fzf git stow yay zoxide; do \
		if command -v $$cmd >/dev/null 2>&1; then \
			echo "✅ $$cmd available"; \
		else \
			echo "❌ $$cmd not found"; \
		fi; \
	done
	@echo "=== Verification completed ==="

# Clean up installation artifacts
clean:
	@echo "=== Cleaning up ==="
	@if [ -d "/tmp/yay" ]; then \
		rm -rf /tmp/yay; \
	fi
	@echo "=== Cleanup completed ==="

# Display help information
help:
	@echo "Manolo's Simplified Arch Linux Dotfiles Setup"
	@echo ""
	@echo "Available targets:"
	@echo "  all                    - Run complete dotfile setup"
	@echo "  check-dotfiles         - Verify dotfiles directory exists locally"
	@echo "  install-packages       - Install packages from restore script"
	@echo "  install-ohmyzsh        - Install Oh My Zsh manually"
	@echo "  setup-ohmyzsh-plugins  - Setup Oh My Zsh plugins and themes"
	@echo "  change-shell           - Change default shell to zsh"
	@echo "  cleanup-and-stow       - Clean configs and stow all dotfiles"
	@echo "  verify-configs         - Verify critical configurations after stowing"
	@echo "  verify-complete-setup   - Verify complete setup"
	@echo "  clean                  - Clean up installation artifacts"
	@echo "  help                   - Display this help message"
	@echo ""
	@echo "Usage:"
	@echo "  make all                           # Complete setup"
	@echo "  make install-packages               # Install packages only"
	@echo "  make setup-ohmyzsh-plugins         # Setup Oh My Zsh plugins only"
	@echo "  make cleanup-and-stow              # Clean configs and stow dotfiles"
	@echo "  make verify-complete-setup         # Verify complete setup"
	@echo ""
	@echo "After installation:"
	@echo "  - Packages restored from existing pkglist.txt and aurlist.txt"
	@echo "  - Oh My Zsh configured with Powerlevel10k and essential plugins"
	@echo "  - Shell changed to zsh"
	@echo "  - All configurations stowed from your local dotfiles"
	@echo "  - User backups created with .backup.* suffix if needed"